name: Build PowerShell EXE using IExpress

on:
  workflow_dispatch:
    inputs:
      payload_url:
        description: 'URL to fetch payload script'
        required: true
        type: string

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Check IExpress Availability
      shell: cmd
      run: where iexpress || echo "IExpress not found!"

    - name: Fetch Payload Script
      shell: powershell
      run: |
        $url = '${{ github.event.inputs.payload_url }}'
        Invoke-WebRequest -Uri $url -OutFile 'payload.ps1'
        if (!(Test-Path "payload.ps1")) { throw "Payload download failed!" }

    - name: Create IExpress SED File
      shell: powershell
      run: |
        $sedContent = @"
        [Version]
        Class=IEXPRESS
        SEDVersion=3
        [Options]
        PackagePurpose=InstallApp
        ShowInstallProgramWindow=1
        HideExtractAnimation=0
        UseLongFileName=1
        InsideCompressed=0
        CAB_FixedSize=0
        RebootMode=N
        InstallPrompt=
        DisplayLicense=
        FinishMessage=
        TargetName=C:\Users\runneradmin\payload.exe
        FriendlyName=PowerShell Payload
        AppLaunched=powershell.exe -ExecutionPolicy Bypass -File payload.ps1
        PostInstallCmd=<None>
        AdminQuietInstCmd=
        UserQuietInstCmd=
        SourceFiles=SourceFiles
        [SourceFiles]
        SourceFiles0=payload.ps1
        [Strings]
        AppName=PowerShell Payload
        "@
        $sedContent | Set-Content -Path "package.sed" -Encoding ASCII

    - name: Run IExpress
      shell: cmd
      run: |
        iexpress /N /Q package.sed || echo "IExpress failed!" && exit 1

    - name: Upload IExpress Log
      uses: actions/upload-artifact@v4
      with:
        name: iexpress_log
        path: iexpress_log.txt

    - name: Upload Executable
      uses: actions/upload-artifact@v4
      with:
        name: payload_exe
        path: C:\Users\runneradmin\payload.exe



